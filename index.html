<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TutorPal - Student Login</title>
    <link rel="stylesheet" href="styles/login-style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
</head>
<body class="login-body">
    <div class="login-container">
        <div class="login-header">
            <img width="100" height="100" src="https://img.icons8.com/bubbles/100/training.png" alt="training"/>
            <h1>TutorPal</h1>
            <h2>Student Login</h2>
        </div>

        <form id="student-login-form">
            <div class="login-form-group">
                <label for="student-number">Student Number</label>
                <input type="text" id="student-number" placeholder="Enter your student number" required>
            </div>

            <div class="login-form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password" required>
            </div>

            <div class="login-form-options">
                <label class="remember-me">
                    <input type="checkbox"> Remember me
                </label>
                <a href="#" class="forgot-password">Forgot password?</a>
            </div>

            <button type="submit" class="login-btn">Login</button>
            <div id="error-message" class="error-message"></div>
        </form>

        <div class="login-footer">
            <p>Need help? Contact <a href="mailto:231240942@tut4life.ac.za">Admin</a></p>
            <p class="copyright">&copy; TutorPal</p>
        </div>
    </div>

    <script>
    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDKxS5yJU-6KiOs_fVO03tXoPC6sLFbnJU",
        authDomain: "tutorpal-98679.firebaseapp.com",
        projectId: "tutorpal-98679",
        storageBucket: "tutorpal-98679.appspot.com",
        messagingSenderId: "473172390647",
        appId: "1:473172390647:web:04d7cb1d550a91dc8059f2",
        measurementId: "G-538MQ597GM"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    document.addEventListener('DOMContentLoaded', () => {
        const loginForm = document.getElementById('student-login-form');
        const forgotPasswordLink = document.querySelector('.forgot-password');
        const errorMessage = document.getElementById('error-message');

        async function handleLogin(event) {
            event.preventDefault();
            errorMessage.textContent = '';

            const studentNumber = document.getElementById('student-number').value.trim();
            const password = document.getElementById('password').value;

            if (!studentNumber || !password) {
                showError("Please fill in all fields");
                return;
            }

            try {
                const studentDoc = await db.collection("Student").doc(studentNumber).get();

                if (!studentDoc.exists) {
                    showError("Student number not found");
                    return;
                }

                const studentData = studentDoc.data();
                const studentEmail = studentData['student-email'];

                await auth.signInWithEmailAndPassword(studentEmail, password);
                window.location.href = "student-dashboard.html";

            } catch (error) {
                console.error("Login error:", error);
                handleAuthError(error);
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            errorMessage.textContent = '';

            const studentNumber = document.getElementById('student-number').value.trim();

            if (!studentNumber) {
                showError("Please enter your student number first");
                return;
            }

            try {
                const studentDoc = await db.collection("Student").doc(studentNumber).get();

                if (!studentDoc.exists) {
                    showError("Student number not found");
                    return;
                }

                const studentData = studentDoc.data();
                const studentEmail = studentData['student-email'];

                await auth.sendPasswordResetEmail(studentEmail);
                showError("Password reset email sent. Check your inbox.", "success");

            } catch (error) {
                console.error("Password reset error:", error);
                handleAuthError(error);
            }
        }

        function handleAuthError(error) {
            switch (error.code) {
                case 'auth/wrong-password':
                    showError("Incorrect password");
                    break;
                case 'auth/user-not-found':
                    showError("Account not found");
                    break;
                case 'auth/too-many-requests':
                    showError("Too many attempts. Try again later.");
                    break;
                default:
                    showError("Login failed. Please try again.");
            }
        }

        function showError(message, type = "error") {
            errorMessage.textContent = message;
            errorMessage.className = `error-message ${type}`;
        }

        loginForm.addEventListener('submit', handleLogin);
        forgotPasswordLink.addEventListener('click', handleForgotPassword);
    });
    </script>
</body>
</html>